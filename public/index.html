<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K8X2VVFK');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Socket.IO</title>
    <link rel="stylesheet" href="style.css">
    <!-- Confeti para celebraciones -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K8X2VVFK"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="container">
        <div class="header-sticky">
            <h1>Bingo en Vivo</h1>

            <div class="game-info">
                <div class="info-card">
                    <span class="label">Participantes</span>
                    <span id="statCards" class="value">--</span>
                </div>
                <div class="info-card prize">
                    <span class="label">Pozo Acumulado</span>
                    <span id="statPrize" class="value">S/ 0.00</span>
                </div>
            </div>

            <div class="current-number-display">
                <h2>NÃºmero Actual:</h2>
                <span id="currentNumber">--</span>
            </div>
            
            <div class="reactions-bar">
                <button class="reaction-btn" onclick="sendReaction('Â¡BINGO! ğŸ†')">Â¡BINGO! ğŸ†</button>
                <button class="reaction-btn" onclick="sendReaction('Â¡Casi! ğŸ¤')">Â¡Casi! ğŸ¤</button>
                <button class="reaction-btn" onclick="sendReaction('Â¡Me falta 1! ğŸ˜±')">Â¡Me falta 1! ğŸ˜±</button>
                <button class="reaction-btn" onclick="sendReaction('Â¡Suerte! ğŸ€')">Â¡Suerte! ğŸ€</button>
                <button class="reaction-btn" onclick="sendReaction('ğŸ˜‚')">ğŸ˜‚</button>
            </div>
        </div>

        <div id="reactionsDisplay"></div>

        <div id="approachingSection" class="approaching-section hidden">
            <h3>ğŸ”¥ Â¡Jugadores en Zona! ğŸ”¥</h3>
            <div id="approachingList" class="approaching-list"></div>
        </div>
        
        <div class="bingo-card-section">
            <h2 id="cardTitle">Tu Cartilla</h2>
            <div id="tabsContainer" class="tabs-container"></div>
            <div id="bingoCardContainer" class="bingo-card"></div>
        </div>

        <div class="called-numbers">
            <h3>NÃºmeros Sacados:</h3>
            <ul id="calledNumbersList"></ul>
        </div>
        <p id="gameOverMessage" class="hidden">El juego ha terminado. Â¡Todos los nÃºmeros han sido llamados!</p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Obtener el token de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('t');

        // Enviar el token en la conexiÃ³n para identificar al jugador
        const socket = io({
            query: { token }
        });

        const currentNumberSpan = document.getElementById('currentNumber');
        const calledNumbersList = document.getElementById('calledNumbersList');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const bingoCardContainer = document.getElementById('bingoCardContainer');
        const tabsContainer = document.getElementById('tabsContainer');
        const statCards = document.getElementById('statCards');
        const statPrize = document.getElementById('statPrize');
        const cardTitle = document.getElementById('cardTitle');

        let userCards = [];
        let gameEnded = false;
        let audioEnabled = false;
        let currentCardIndex = 0;
        let playerName = 'Jugador';
        let hasWelcomed = false;
        let lastEncouragementTime = 0;

        // SELECCIÃ“N DE VOZ MEJORADA
        let selectedVoice = null;
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            // Prioridad: Google EspaÃ±ol, voces Naturales, es-PE (PerÃº), es-419 (LatinoamÃ©rica), es-MX, es-ES
            selectedVoice = voices.find(v => v.name.includes('Google') && v.lang.startsWith('es')) ||
                            voices.find(v => v.name.includes('Natural') && v.lang.startsWith('es')) ||
                            voices.find(v => v.lang === 'es-PE') ||
                            voices.find(v => v.lang === 'es-419') ||
                            voices.find(v => v.lang === 'es-MX') ||
                            voices.find(v => v.lang.startsWith('es'));
        }
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        function welcomePlayer(name) {
            if (hasWelcomed) return;
            // ACTIVACIÃ“N AUTOMÃTICA DE SONIDO (Sin mensaje de voz)
            audioEnabled = true;
            hasWelcomed = true;
            console.log("Audio habilitado para el jugador:", name);
        }

        socket.on('bingo:player_info', (data) => {
            playerName = data.name;

            // Evento GTM: Jugador ingresÃ³ al juego
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'game_joined',
                'player_name': playerName
            });

            // Intento 1: Saludo automÃ¡tico inmediato
            setTimeout(() => welcomePlayer(playerName), 500);
        });

        // Intento 2: Saludo al primer toque de pantalla (respaldo si el navegador bloquea el anterior)
        document.addEventListener('click', () => welcomePlayer(playerName), { once: true });
        document.addEventListener('touchstart', () => welcomePlayer(playerName), { once: true });

        function getBingoLetter(num) {
            if (num <= 15) return 'B';
            if (num <= 30) return 'I';
            if (num <= 45) return 'N';
            if (num <= 60) return 'G';
            return 'O';
        }

        function speak(number) {
            if (audioEnabled && 'speechSynthesis' in window) {
                // LIMPIEZA: Cancelar cualquier audio previo para evitar retrasos
                window.speechSynthesis.cancel();

                const letter = getBingoLetter(number);
                const text = `${letter}, ${number}`;
                const utterance = new SpeechSynthesisUtterance(text);
                if (selectedVoice) utterance.voice = selectedVoice;
                utterance.lang = 'es-PE';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        function speakCustom(text) {
            // MODO MINIMALISTA: Desactivado por ahora
            /*
            if (audioEnabled && 'speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                if (selectedVoice) utterance.voice = selectedVoice;
                utterance.lang = 'es-PE';
                utterance.rate = 0.95;
                window.speechSynthesis.speak(utterance);
            }
            */
        }

        function launchVictoryConfetti() {
            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            const randomInRange = (min, max) => Math.random() * (max - min) + min;

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        }

        socket.on('bingo:your_cards', (cards) => {
            userCards = cards;
            renderAllCards(userCards);
            if (cards.length > 1) {
                cardTitle.textContent = `Tienes ${cards.length} Cartillas`;
            }
        });

        socket.on('bingo:initial_numbers', (numbers) => {
            numbers.forEach(number => {
                addNumberToDisplay(number);
                markNumberOnAllCards(number);
            });
            if (numbers.length > 0) {
                currentNumberSpan.textContent = numbers[numbers.length - 1];
            }
        });

        socket.on('bingo:new_number', (number) => {
            if (gameEnded) return;
            currentNumberSpan.textContent = number;
            addNumberToDisplay(number);
            markNumberOnAllCards(number);
            speak(number);
            gameOverMessage.classList.add('hidden');
        });

        socket.on('bingo:stats', (data) => {
            statCards.textContent = data.totalCards;
            statPrize.textContent = `S/ ${data.totalPrize}`;
        });

        socket.on('bingo:game_over', (message) => {
            gameEnded = true;
            currentNumberSpan.textContent = 'FIN';
            gameOverMessage.textContent = message;
            gameOverMessage.classList.remove('hidden');
        });

        socket.on('bingo:winner', (data) => {
            gameEnded = true;
            
            // Soporte para mÃºltiples ganadores
            const winners = data.allWinners || [data];
            const winnerIds = winners.map(w => w.id);
            const isMe = winnerIds.includes(socket.id);

            currentNumberSpan.textContent = isMe ? 'Â¡GANASTE!' : 'Â¡BINGO!';
            
            if (isMe) {
                launchVictoryConfetti();
                speakCustom(`Â¡Felicidades ${playerName}! Has cantado Bingo y eres el ganador del pozo. Â¡IncreÃ­ble victoria!`);
                
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'event': 'bingo_win',
                    'player_name': playerName
                });

                let msg = 'ğŸ‰ <strong>Â¡FELICIDADES!</strong> ğŸ‰<br>Has completado tu cartilla y ganado el <strong>BINGO REAL</strong>.<br>';
                if (winners.length > 1) {
                    msg += `<small>(Hubo ${winners.length} ganadores simultÃ¡neos)</small><br>`;
                }
                msg += 'Nos pondremos en contacto contigo para tu premio.';

                gameOverMessage.innerHTML = msg;
                gameOverMessage.style.color = '#155724';
                gameOverMessage.style.background = '#d4edda';
                gameOverMessage.style.padding = '20px';
                gameOverMessage.style.borderRadius = '15px';
                gameOverMessage.style.border = '3px solid #28a745';
                gameOverMessage.style.fontSize = '1.2rem';
            } else {
                const phones = winners.map(w => w.phone).join(', ');
                gameOverMessage.textContent = `Los jugadores con celular ${phones} han ganado el BINGO.`;
                gameOverMessage.style.color = '#dc3545';
                gameOverMessage.style.background = 'none';
                gameOverMessage.style.border = 'none';
                gameOverMessage.style.fontSize = '1rem';
            }
            
            gameOverMessage.classList.remove('hidden');
        });

        socket.on('bingo:trial_winner', (data) => {
            const isMe = socket.id === data.id;
            if (isMe) {
                launchVictoryConfetti();
                // Evento GTM: Ganador de prueba
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'event': 'trial_win',
                    'player_name': playerName
                });

                currentNumberSpan.textContent = 'Â¡BINGO!';
                gameOverMessage.innerHTML = `
                    ğŸ† <strong>Â¡Felicidades!</strong> Has ganado en el <strong>MODO PRUEBA</strong>.<br><br>
                    Â¿Te gustÃ³ la experiencia? PrepÃ¡rate...<br>
                    <span id="redirectTimer" style="font-size: 1.2rem; font-weight: bold;">RedirigiÃ©ndote para jugar por premios reales en 10...</span>
                `;
                gameOverMessage.style.color = '#6c5ce7';
                gameOverMessage.style.background = '#f0f0ff';
                gameOverMessage.style.padding = '15px';
                gameOverMessage.style.borderRadius = '10px';
                gameOverMessage.style.border = '2px solid #6c5ce7';
                gameOverMessage.classList.remove('hidden');

                // LÃ³gica de redirecciÃ³n automÃ¡tica para romper el bucle
                let timeLeft = 10;
                const timerEl = document.getElementById('redirectTimer');
                const interval = setInterval(() => {
                    timeLeft--;
                    if (timeLeft > 0) {
                        timerEl.innerText = `RedirigiÃ©ndote para jugar por premios reales en ${timeLeft}...`;
                    } else {
                        clearInterval(interval);
                        // LIMPIEZA CRÃTICA: Borrar tokens para evitar bucle en el inicio
                        localStorage.removeItem('bingo_phone');
                        localStorage.removeItem('bingo_request_token');
                        window.location.href = '/';
                    }
                }, 1000);
            }
        });

        socket.on('bingo:reset', () => {
            localStorage.removeItem('bingo_phone');
            localStorage.removeItem('bingo_request_token');
            alert('El juego ha sido reiniciado por el administrador. SerÃ¡s redirigido para una nueva partida.');
            window.location.href = '/';
        });

        socket.on('bingo:unauthorized', (msg) => {
            localStorage.removeItem('bingo_phone');
            localStorage.removeItem('bingo_request_token');
            alert(msg);
            window.location.href = '/';
        });

        socket.on('bingo:reaction', (data) => {
            showFloatingReaction(data.sender, data.text);
        });

        socket.on('bingo:approaching', (list) => {
            updateApproachingList(list);
        });

        function updateApproachingList(list) {
            const section = document.getElementById('approachingSection');
            const container = document.getElementById('approachingList');
            
            if (list.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            container.innerHTML = '';

            list.forEach(p => {
                const badge = document.createElement('span');
                badge.className = `approaching-badge missing-${p.missing}`;
                const trialTag = p.isTrial ? ' (Prueba)' : '';
                badge.innerText = `ğŸ“± ${p.phone}${trialTag} (Â¡le falta ${p.missing}!)`;
                container.appendChild(badge);
            });
        }

        function sendReaction(text) {
            socket.emit('bingo:reaction', text);
            // Evento GTM: ReacciÃ³n enviada (Engagement)
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'reaction_sent',
                'reaction_type': text
            });
        }

        function showFloatingReaction(sender, text) {
            const display = document.getElementById('reactionsDisplay');
            const el = document.createElement('div');
            el.className = 'floating-reaction';
            el.innerHTML = `
                <span class="sender">${sender}</span>
                <span class="text">${text}</span>
            `;
            display.appendChild(el);
            
            // Eliminar el elemento despuÃ©s de que termine la animaciÃ³n
            setTimeout(() => {
                el.remove();
            }, 3000);
        }

        function addNumberToDisplay(number) {
            const listItem = document.createElement('li');
            listItem.textContent = number;
            calledNumbersList.prepend(listItem);
        }

        function renderAllCards(cards) {
            bingoCardContainer.innerHTML = '';
            tabsContainer.innerHTML = '';

            cards.forEach((card, index) => {
                // Crear BotÃ³n de Tab
                if (cards.length > 1) {
                    const btn = document.createElement('button');
                    btn.className = 'tab-button' + (index === 0 ? ' active' : '');
                    btn.textContent = `Cartilla ${index + 1}`;
                    btn.onclick = () => switchCard(index);
                    tabsContainer.appendChild(btn);
                }

                // Crear Tabla de Cartilla
                const table = document.createElement('table');
                table.id = `card-table-${index}`;
                if (index !== 0) table.classList.add('hidden-card');
                
                const headerRow = table.insertRow();
                ['B', 'I', 'N', 'G', 'O'].forEach(letter => {
                    const th = document.createElement('th');
                    th.textContent = letter;
                    headerRow.appendChild(th);
                });

                card.forEach(row => {
                    const tr = table.insertRow();
                    row.forEach(cellValue => {
                        const td = tr.insertCell();
                        td.textContent = cellValue;
                        td.dataset.number = cellValue;
                        if (cellValue === 'FREE') {
                            td.classList.add('free-space', 'marked');
                        }
                    });
                });
                bingoCardContainer.appendChild(table);
            });
        }

        function switchCard(index) {
            currentCardIndex = index;
            const tables = bingoCardContainer.querySelectorAll('table');
            const buttons = tabsContainer.querySelectorAll('.tab-button');
            
            tables.forEach((t, i) => {
                t.classList.toggle('hidden-card', i !== index);
            });
            buttons.forEach((b, i) => {
                b.classList.toggle('active', i === index);
            });
        }

        function markNumberOnAllCards(number) {
            const cells = bingoCardContainer.querySelectorAll(`[data-number="${number}"]`);
            cells.forEach(cell => {
                cell.classList.add('marked');
            });
            // DespuÃ©s de marcar, verificar si el jugador estÃ¡ cerca de ganar
            setTimeout(checkEncouragement, 1000);
        }

        function checkEncouragement() {
            if (!audioEnabled || gameEnded || Date.now() - lastEncouragementTime < 40000) return;

            let minMissing = 5;
            const tables = bingoCardContainer.querySelectorAll('table');
            
            tables.forEach(table => {
                const rows = table.querySelectorAll('tr');
                // Verificar filas
                for (let r = 1; r < rows.length; r++) {
                    let missing = 0;
                    const tds = rows[r].querySelectorAll('td');
                    tds.forEach(td => { if (!td.classList.contains('marked')) missing++; });
                    if (missing < minMissing) minMissing = missing;
                }
                // Verificar columnas
                for (let c = 0; c < 5; c++) {
                    let missing = 0;
                    for (let r = 1; r < rows.length; r++) {
                        const td = rows[r].querySelectorAll('td')[c];
                        if (!td.classList.contains('marked')) missing++;
                    }
                    if (missing < minMissing) minMissing = missing;
                }
            });

            if (minMissing === 1 || minMissing === 2) {
                const msg = minMissing === 1 
                    ? `Â¡AtenciÃ³n ${playerName}! Solo te falta un nÃºmero para el Bingo. Â¡Mucha suerte!` 
                    : `Â¡PrepÃ¡rate ${playerName}! EstÃ¡s muy cerca de ganar tu Bingo.`;
                speakCustom(msg);
                lastEncouragementTime = Date.now();
            }
        }
    </script>
</body>
</html>
